<div class="flex justify-between border-b pb-3">
  <!-- Title -->
  <h1 class="text-4xl font-extrabold leading-none tracking-tight">Nuevo Crédito</h1>
  <button
    mat-icon-button
    aria-label="Regresar"
    (click)="back()"
    #tooltip="matTooltip"
    matTooltip="Regresar"
    [matTooltipPosition]="'below'">
    <mat-icon svgIcon="heroicons_outline:arrow-left"></mat-icon>
  </button>
</div>
<ng-container *ngIf="loading$ | async; then loadingTemplate; else formTemplate"></ng-container>
<ng-template #formTemplate>
  <form [formGroup]="creditosForm" class="flex flex-auto">
    <mat-stepper
      [linear]="true"
      #stepper
      class="flex w-full flex-auto flex-col items-center"
      [orientation]="orientation"
      (selectionChange)="selectionChange($event)">
      <mat-step [stepControl]="sucursal" label="Datos Generales del crédito">
        <!-- Main actions -->
        <div class="flex flex-auto flex-col items-center gap-6 md:p-10">
          <!-- Search -->
          <div class="w-full" *ngIf="!clienteId">
            <mat-form-field class="fuse-mat-dense min-w-5 w-full" subscriptSizing="dynamic">
              <mat-icon class="icon-size-5" matPrefix [svgIcon]="'heroicons_solid:search'"></mat-icon>
              <input matInput [formControl]="searchInput" [matAutocomplete]="auto" [placeholder]="'Buscar cliente'" />
              <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn">
                <ng-container *ngIf="clientes$ | async as clientes">
                  <ng-container *ngIf="clientes.length > 0; else noResultsTemplate">
                    <mat-option *ngFor="let cliente of clientes" [value]="cliente">
                      {{ cliente.nombre }} {{ cliente.apellidoPaterno }}
                      {{ cliente.apellidoMaterno }}
                    </mat-option>
                  </ng-container>
                  <ng-template #noResultsTemplate>
                    <mat-option class="font-bold" *ngIf="searchInput.value"
                      >No existen clientes con ese criterio</mat-option
                    >
                  </ng-template>
                </ng-container>
              </mat-autocomplete>
            </mat-form-field>
          </div>
          <ng-container *ngIf="!loading; else loadingTemplate">
            <div class="flex flex-col gap-8" *ngIf="selectedCliente$ | async as cliente">
              <div class="flex w-full flex-col gap-6">
                <h2 class="self-center text-3xl font-extrabold leading-none tracking-tight">Datos del Cliente</h2>
                <div class="mt-3 grid w-full grid-cols-1 content-center gap-6 border-b border-t py-6 md:grid-cols-4">
                  <!-- Nombre -->
                  <div class="flex flex-col gap-2">
                    <div class="flex gap-2">
                      <mat-icon
                        role="img"
                        class="mat-icon notranslate mat-icon-no-color"
                        aria-hidden="true"
                        [svgIcon]="'heroicons_solid:user'"
                        matPrefix>
                      </mat-icon>
                      <div class="font-light leading-6">Nombre:</div>
                    </div>
                    <div class="ml-4 font-bold leading-6">
                      {{ cliente.nombre }} {{ cliente.apellidoPaterno }}
                      {{ cliente.apellidoMaterno }}
                    </div>
                  </div>
                  <!-- Direccion -->
                  <div class="flex flex-col gap-2">
                    <div class="flex gap-2">
                      <mat-icon
                        role="img"
                        class="mat-icon notranslate mat-icon-no-color"
                        aria-hidden="true"
                        [svgIcon]="'heroicons_outline:location-marker'"
                        matPrefix>
                      </mat-icon>
                      <div class="font-light leading-6">Dirección:</div>
                    </div>
                    <div class="ml-4 font-bold leading-6">
                      {{ cliente.direcciones[0].calle }}, {{ cliente.direcciones[0].numero }},
                      {{ cliente.direcciones[0].cruzamientos }}, {{ cliente.direcciones[0].colonia.descripcion }}, CP
                      {{ cliente.direcciones[0].colonia.codigoPostal }}
                    </div>
                  </div>
                  <!-- CURP -->
                  <div class="flex flex-col gap-2">
                    <div class="flex gap-2">
                      <mat-icon
                        role="img"
                        class="mat-icon notranslate mat-icon-no-color"
                        aria-hidden="true"
                        [svgIcon]="'heroicons_outline:clipboard-check'"
                        matPrefix>
                      </mat-icon>
                      <div class="font-light leading-6">CURP:</div>
                    </div>
                    <div class="ml-4 font-bold leading-6">
                      {{ cliente.curp }}
                    </div>
                  </div>
                  <!-- RFC -->
                  <div class="flex flex-col gap-2">
                    <div class="flex gap-2">
                      <mat-icon
                        role="img"
                        class="mat-icon notranslate mat-icon-no-color"
                        aria-hidden="true"
                        [svgIcon]="'heroicons_outline:clipboard-check'"
                        matPrefix>
                      </mat-icon>
                      <div class="font-light leading-6">RFC:</div>
                    </div>
                    <div class="ml-4 font-bold leading-6">
                      {{ cliente.rfc }}
                    </div>
                  </div>
                  <!-- Telefono 1-->
                  <div class="flex flex-col gap-2">
                    <div class="flex gap-2">
                      <mat-icon
                        role="img"
                        class="mat-icon notranslate mat-icon-no-color"
                        aria-hidden="true"
                        [svgIcon]="'heroicons_outline:phone'"
                        matPrefix>
                      </mat-icon>
                      <div class="font-light leading-6">Teléfono 1:</div>
                    </div>
                    <div class="ml-4 font-bold leading-6">
                      {{ cliente.telefono1 }}
                    </div>
                  </div>
                  <!-- Telefono 2-->
                  <div class="flex flex-col gap-2" *ngIf="cliente.telefono2">
                    <div class="flex gap-2">
                      <mat-icon
                        role="img"
                        class="mat-icon notranslate mat-icon-no-color"
                        aria-hidden="true"
                        [svgIcon]="'heroicons_outline:phone'"
                        matPrefix>
                      </mat-icon>
                      <div class="font-light leading-6">Teléfono 2:</div>
                    </div>
                    <div class="ml-4 font-bold leading-6">
                      {{ cliente.telefono2 }}
                    </div>
                  </div>
                </div>
                <div class="felx-col flex flex-auto items-center justify-center gap-6 md:grid md:grid-cols-2">
                  <ng-container *ngIf="productos$ | async as productos">
                    <ng-container *ngIf="productos.length > 0; else noProductosTemplate">
                      <!-- Producto -->
                      <div class="w-full">
                        <mat-form-field class="w-full" subscriptSizing="dynamic">
                          <mat-label>Elegír producto a utilizar</mat-label>
                          <mat-icon
                            class="icon-size-5"
                            [svgIcon]="'heroicons_outline:currency-dollar'"
                            matPrefix></mat-icon>
                          <mat-select [formControl]="producto" (selectionChange)="selectProducto($event.value)">
                            <mat-option
                              class="h-auto py-4 leading-none"
                              *ngFor="let producto of productos$ | async"
                              [value]="producto.id">
                              <div class="font-medium">
                                {{ producto.descripcion }}
                              </div>
                            </mat-option>
                          </mat-select>
                        </mat-form-field>
                        <ng-container *ngIf="producto.touched">
                          <mat-error *ngIf="producto.errors?.['required']"> El producto es requerido. </mat-error>
                        </ng-container>
                      </div>
                    </ng-container>
                    <ng-template #noProductosTemplate>
                      <div class="py-4 text-center font-bold">No existen productos para ofrecer, agregar uno</div>
                    </ng-template>
                  </ng-container>
                  <!-- Sucursales -->
                  <ng-container *ngIf="selectedProducto">
                    <ng-container *ngIf="sucursales$ | async as sucursales">
                      <ng-container *ngIf="sucursales.length > 0; else noSucursalesTemplate">
                        <div class="w-full">
                          <mat-form-field class="w-full" subscriptSizing="dynamic">
                            <mat-label>Sucursal</mat-label>
                            <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:library'" matPrefix></mat-icon>
                            <mat-select [formControlName]="'sucursal'">
                              <mat-option>Elija una opción</mat-option>

                              <mat-option *ngFor="let sucursal of sucursales" [value]="sucursal.id">{{
                                sucursal.nombre
                              }}</mat-option>
                            </mat-select>
                          </mat-form-field>
                          <ng-container *ngIf="sucursal.touched">
                            <mat-error *ngIf="sucursal.errors?.['required']"> La sucursal es requerida. </mat-error>
                          </ng-container>
                        </div> </ng-container
                      ><ng-template #noSucursalesTemplate>
                        <div class="py-4 text-center font-bold">
                          <p>No existen sucursales con la cantidad de dinero para otorgar el préstamo,</p>
                          <p>verifique que exista un turno abierto</p>
                        </div>
                      </ng-template></ng-container
                    >
                  </ng-container>
                </div>
              </div>
            </div>
            <ng-container *ngIf="selectedProducto$ | async as producto">
              <h2 class="self-center text-3xl font-extrabold leading-none tracking-tight">Datos del Producto</h2>
              <div class="mt-2 grid w-full grid-cols-1 content-center gap-6 border-b border-t py-8 md:grid-cols-4">
                <!-- Descripción -->
                <div class="flex flex-col gap-2">
                  <div class="flex gap-2">
                    <mat-icon
                      role="img"
                      class="mat-icon notranslate mat-icon-no-color"
                      aria-hidden="true"
                      [svgIcon]="'heroicons_outline:credit-card'"
                      matPrefix>
                    </mat-icon>
                    <div class="font-light leading-6">Nombre:</div>
                  </div>
                  <div class="ml-4 font-bold leading-6">
                    {{ producto.descripcion }}
                  </div>
                </div>
                <!-- Tasa de Interes -->
                <div class="flex flex-col gap-2">
                  <div class="flex gap-2">
                    <mat-icon
                      role="img"
                      class="mat-icon notranslate mat-icon-no-color"
                      aria-hidden="true"
                      [svgIcon]="'heroicons_outline:trending-up'"
                      matPrefix>
                    </mat-icon>
                    <div class="font-light leading-6">Tasa de Interés:</div>
                  </div>
                  <div class="ml-4 font-bold leading-6">
                    {{ (producto.interes | decimalToNumber) / 100 | percent : '1.2' }}
                  </div>
                </div>
                <!-- Interés moratorio -->
                <div class="flex flex-col gap-2">
                  <div class="flex gap-2">
                    <mat-icon
                      role="img"
                      class="mat-icon notranslate mat-icon-no-color"
                      aria-hidden="true"
                      [svgIcon]="'heroicons_outline:trending-up'"
                      matPrefix>
                    </mat-icon>
                    <div class="font-light leading-6">Interés moratorio:</div>
                  </div>
                  <div class="ml-4 font-bold leading-6">
                    {{ (producto.interesMoratorio | decimalToNumber) / 100 | percent : '1.2' }}
                  </div>
                </div>
                <!-- Comisión por apertura -->
                <div class="flex flex-col gap-2">
                  <div class="flex gap-2">
                    <mat-icon
                      role="img"
                      class="mat-icon notranslate mat-icon-no-color"
                      aria-hidden="true"
                      [svgIcon]="'heroicons_outline:trending-up'"
                      matPrefix>
                    </mat-icon>
                    <div class="font-light leading-6">Comisión por apertura:</div>
                  </div>
                  <div class="ml-4 font-bold leading-6">
                    {{ (producto.comision | decimalToNumber) / 100 | percent : '1.2' }}
                  </div>
                </div>
                <!-- Penalización -->
                <div class="flex flex-col gap-2">
                  <div class="flex gap-2">
                    <mat-icon
                      role="img"
                      class="mat-icon notranslate mat-icon-no-color"
                      aria-hidden="true"
                      [svgIcon]="'heroicons_outline:trending-up'"
                      matPrefix>
                    </mat-icon>
                    <div class="font-light leading-6">Penalización incumplimiento de plazo:</div>
                  </div>
                  <div class="ml-4 font-bold leading-6">
                    {{
                      producto.tipoPenalizacion === 'PORCENTAJE'
                        ? ((producto.penalizacion | decimalToNumber) / 100 | percent : '1.2')
                        : (producto.penalizacion | decimalToNumber | currency : 'MXN' : 'symbol')
                    }}
                  </div>
                </div>
                <!-- Cargos -->
                <div class="flex flex-col gap-2">
                  <div class="flex gap-2">
                    <mat-icon
                      role="img"
                      class="mat-icon notranslate mat-icon-no-color"
                      aria-hidden="true"
                      [svgIcon]="'heroicons_outline:trending-up'"
                      matPrefix>
                    </mat-icon>
                    <div class="font-light leading-6">Cargos:</div>
                  </div>
                  <div class="ml-4 font-bold leading-6">
                    {{
                      (producto.cargos | decimalToNumber) === 0
                        ? 'No Hay Cargos'
                        : ((producto.cargos | decimalToNumber) / 100 | percent : '1.2')
                    }}
                  </div>
                </div>
                <!-- Frecuencia de Pago -->
                <div class="flex flex-col gap-2">
                  <div class="flex gap-2">
                    <mat-icon
                      role="img"
                      class="mat-icon notranslate mat-icon-no-color"
                      aria-hidden="true"
                      [svgIcon]="'heroicons_outline:credit-card'"
                      matPrefix>
                    </mat-icon>
                    <div class="font-light leading-6">Frecuencia de Pago:</div>
                  </div>
                  <div class="ml-4 font-bold leading-6">
                    {{ producto.frecuencia | titlecase }}
                  </div>
                </div>
                <!-- Número de Pagos -->
                <div class="flex flex-col gap-2">
                  <div class="flex gap-2">
                    <mat-icon
                      role="img"
                      class="mat-icon notranslate mat-icon-no-color"
                      aria-hidden="true"
                      [svgIcon]="'heroicons_outline:credit-card'"
                      matPrefix>
                    </mat-icon>
                    <div class="font-light leading-6">Número de Pagos:</div>
                  </div>
                  <div class="ml-4 font-bold leading-6">
                    {{ producto.numeroDePagos | number }}
                  </div>
                </div>
                <!-- Monto Mínimo -->
                <div class="flex flex-col gap-2">
                  <div class="flex gap-2">
                    <mat-icon
                      role="img"
                      class="mat-icon notranslate mat-icon-no-color"
                      aria-hidden="true"
                      [svgIcon]="'heroicons_outline:currency-dollar'"
                      matPrefix>
                    </mat-icon>
                    <div class="font-light leading-6">Monto Mínimo:</div>
                  </div>
                  <div class="ml-4 font-bold leading-6">
                    {{ producto.montoMinimo | decimalToNumber | currency : 'MXN' : 'symbol' }}
                  </div>
                </div>
                <!-- Monto Máximo -->
                <div class="flex flex-col gap-2">
                  <div class="flex gap-2">
                    <mat-icon
                      role="img"
                      class="mat-icon notranslate mat-icon-no-color"
                      aria-hidden="true"
                      [svgIcon]="'heroicons_outline:currency-dollar'"
                      matPrefix>
                    </mat-icon>
                    <div class="font-light leading-6">Monto Máximo:</div>
                  </div>
                  <div class="ml-4 font-bold leading-6">
                    {{ producto.montoMaximo | decimalToNumber | currency : 'MXN' : 'symbol' }}
                  </div>
                </div>
              </div>
            </ng-container>
            <div class="flex">
              <button mat-stroked-button type="button" (click)="cancelCredito()">Cancelar</button>
              <button
                class="ml-4"
                mat-flat-button
                type="button"
                [color]="'primary'"
                matStepperNext
                [disabled]="producto.invalid || sucursal.invalid || cliente.invalid">
                Siguiente
              </button>
            </div>
          </ng-container>
        </div>
      </mat-step>
      <mat-step [stepControl]="aval" label="Datos del Aval"
        ><div class="my-5 flex w-full flex-col gap-6 md:p-10">
          <h2 class="self-center text-3xl font-extrabold leading-none tracking-tight">Datos del Aval</h2>
          <div class="mt-8 flex w-full flex-wrap gap-6">
            <form [formGroup]="aval" class="grid w-full grid-cols-1 gap-3 md:grid-cols-5">
              <!-- Apellido Paterno -->
              <div>
                <mat-form-field class="w-full" subscriptSizing="dynamic">
                  <mat-label>Apellido Paterno</mat-label>
                  <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:user'" matPrefix></mat-icon>
                  <input [formControlName]="'apellidoPaterno'" matInput type="text" [inputMask]="titleInputMask" />
                </mat-form-field>
                <ng-container *ngIf="aval.get('apellidoPaterno')?.touched">
                  <mat-error *ngIf="aval.get('apellidoPaterno')?.errors?.['required']">
                    El Apellido paterno es requerido.
                  </mat-error>
                </ng-container>
              </div>
              <!-- Apellido Materno -->
              <div>
                <mat-form-field class="w-full" subscriptSizing="dynamic">
                  <mat-label>Apellido Materno</mat-label>
                  <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:user'" matPrefix></mat-icon>
                  <input [formControlName]="'apellidoMaterno'" matInput type="text" [inputMask]="titleInputMask" />
                </mat-form-field>
                <ng-container *ngIf="aval.get('apellidoMaterno')?.touched">
                  <mat-error *ngIf="aval.get('apellidoMaterno')?.errors?.['required']">
                    El Apellido materno es requerido.
                  </mat-error>
                </ng-container>
              </div>
              <!-- Nombre -->
              <div>
                <mat-form-field class="w-full" subscriptSizing="dynamic">
                  <mat-label>Nombre</mat-label>
                  <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:user'" matPrefix></mat-icon>
                  <input [formControlName]="'nombre'" matInput type="text" [inputMask]="titleInputMask" />
                </mat-form-field>
                <ng-container *ngIf="aval.get('nombre')?.touched">
                  <mat-error *ngIf="aval.get('nombre')?.errors?.['required']"> El Nombre es requerido. </mat-error>
                </ng-container>
              </div>
              <!-- Fecha de Nacimiento -->
              <div>
                <mat-form-field class="w-full" subscriptSizing="dynamic">
                  <mat-label>Fecha de Nacimiento</mat-label>
                  <mat-icon matPrefix class="icon-size-5 hidden sm:flex" [svgIcon]="'heroicons_solid:cake'"></mat-icon>
                  <input
                    matInput
                    [matDatepicker]="birthdayDatepicker"
                    [formControlName]="'fechaDeNacimiento'"
                    [placeholder]="'Fecha de Nacimiento'" />
                  <mat-datepicker-toggle matSuffix [for]="birthdayDatepicker"> </mat-datepicker-toggle>
                  <mat-datepicker #birthdayDatepicker></mat-datepicker>
                </mat-form-field>
                <ng-container *ngIf="aval.get('fechaDeNacimiento')?.touched">
                  <mat-error *ngIf="aval.get('fechaDeNacimiento')?.errors?.['required']">
                    La fecha de nacimiento es requerida.
                  </mat-error>
                </ng-container>
              </div>
              <!-- Parentesco -->
              <div>
                <mat-form-field class="w-full" subscriptSizing="dynamic">
                  <mat-label>Parentesco</mat-label>
                  <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:library'" matPrefix></mat-icon>
                  <mat-select [formControlName]="'parentesco'" (selectionChange)="checkParentesco($event.value)">
                    <mat-option *ngFor="let parentesco of parentescos$ | async" [value]="parentesco.id">{{
                      parentesco.descripcion
                    }}</mat-option>
                  </mat-select>
                </mat-form-field>
                <ng-container *ngIf="aval.get('parentesco')?.touched">
                  <mat-error *ngIf="aval.get('parentesco')?.errors?.['required']">
                    El Parentesco es requerido.
                  </mat-error>
                </ng-container>
              </div>
              <!-- Otro (Especificar) -->
              <div *ngIf="selectedOtro$ | async">
                <mat-form-field class="w-full" subscriptSizing="dynamic">
                  <mat-label>Especificar</mat-label>
                  <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:user'" matPrefix></mat-icon>
                  <input [formControlName]="'otro'" matInput type="text" [inputMask]="titleInputMask" />
                </mat-form-field>
                <ng-container *ngIf="aval.get('otro')?.touched">
                  <mat-error *ngIf="aval.get('otro')?.errors?.['required']">
                    La especificación del parentesco es requerida.
                  </mat-error>
                </ng-container>
              </div>
              <!-- Ocupación -->
              <div>
                <mat-form-field class="w-full" subscriptSizing="dynamic">
                  <mat-label>Ocupación</mat-label>
                  <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:user'" matPrefix></mat-icon>
                  <input [formControlName]="'ocupacion'" matInput type="text" [inputMask]="titleInputMask" />
                </mat-form-field>
                <ng-container *ngIf="aval.get('ocupacion')?.touched">
                  <mat-error *ngIf="aval.get('ocupacion')?.errors?.['required']">
                    La Ocupación es requerida.
                  </mat-error>
                </ng-container>
              </div>
              <!-- Teléfono 1 -->
              <div>
                <mat-form-field class="w-full" subscriptSizing="dynamic">
                  <mat-label>Teléfono</mat-label>
                  <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:phone'" matPrefix></mat-icon>
                  <input [formControlName]="'telefono'" matInput [inputMask]="phoneInputMask" type="tel" />
                </mat-form-field>
                <ng-container *ngIf="aval.get('telefono')?.touched">
                  <mat-error *ngIf="aval.get('telefono')?.errors?.['required']"> El telefono es requerido. </mat-error>
                </ng-container>
              </div>
            </form>
            <div class="flex flex-auto justify-center">
              <button mat-stroked-button type="button" matStepperPrevious>Anterior</button>
              <button
                class="ml-4"
                mat-flat-button
                type="button"
                [color]="'primary'"
                matStepperNext
                [disabled]="!aval.touched || aval.invalid">
                Siguiente
              </button>
            </div>
          </div>
        </div></mat-step
      >
      <mat-step label="Seguro y Desembolso" [stepControl]="creditosForm"
        ><div class="flex w-full flex-col gap-6 p-10">
          <h2 class="flex-auto self-center text-3xl font-extrabold leading-none tracking-tight">Datos del Seguro</h2>
          <div class="mt-8 flex w-full flex-col gap-6 md:grid md:grid-cols-2">
            <ng-container *ngIf="segurosData$ | async as data">
              <!-- Modalidad de Seguro -->
              <div>
                <mat-form-field class="w-full" subscriptSizing="dynamic">
                  <mat-label>Modalidad de Seguro</mat-label>
                  <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:library'" matPrefix></mat-icon>
                  <mat-select
                    [formControlName]="'modalidadDeSeguro'"
                    (selectionChange)="selectModalidadDeSeguro($event.value)">
                    <mat-option *ngFor="let modalidad of data.modalidadesDeSeguro" [value]="modalidad.id">{{
                      modalidad.titulo
                    }}</mat-option>
                  </mat-select>
                </mat-form-field>
                <ng-container *ngIf="modalidadDeSeguro.touched">
                  <mat-error *ngIf="modalidadDeSeguro.errors?.['required']">
                    La modalidad de seguro es requerida.
                  </mat-error>
                </ng-container>
              </div>
              <!-- Seguro -->
              <div>
                <mat-form-field class="w-full" subscriptSizing="dynamic"
                  ><mat-label>Seguro</mat-label>
                  <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:library'" matPrefix></mat-icon>
                  <mat-select [formControlName]="'seguro'" (selectionChange)="selectSeguro($event.value)">
                    <mat-option>Elija una opción</mat-option>
                    <ng-container *ngIf="selectedModalidadDeSeguro$ | async">
                      <mat-option *ngFor="let seguro of data.seguros" [value]="seguro.id">{{
                        seguro.nombre
                      }}</mat-option>
                    </ng-container>
                  </mat-select>
                </mat-form-field>
              </div>
            </ng-container>
          </div>
          <h2 class="mt-6 flex-auto self-center text-3xl font-extrabold leading-none tracking-tight">
            Datos Finales y Desembolso
          </h2>
          <div class="mt-8 flex w-full flex-col gap-6 md:flex-row">
            <!-- Cantidad a Desembolsar -->
            <div class="w-full">
              <mat-form-field class="w-full" subscriptSizing="dynamic">
                <mat-label>Cantidad a Otorgar</mat-label>
                <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:currency-dollar'" matPrefix></mat-icon>
                <input [formControlName]="'monto'" matInput [inputMask]="currencyInputMask" />
              </mat-form-field>
              <ng-container *ngIf="monto.touched">
                <mat-error *ngIf="monto.errors?.['required']"> La Cantidad a otorgar es requerida. </mat-error>
                <mat-error *ngIf="monto.errors?.['min'] || monto.errors?.['max']">
                  La Cantidad debe estar entre
                  {{ selectedProducto.montoMinimo | decimalToNumber | currency }}
                  y
                  {{ selectedProducto.montoMaximo | decimalToNumber | currency : 'MXN' : 'symbol' }}.
                </mat-error>
              </ng-container>
            </div>
            <!-- Fecha de Desembolso -->
            <div class="w-full">
              <mat-form-field class="w-full" subscriptSizing="dynamic">
                <mat-label>Fecha de Desembolso</mat-label>
                <mat-icon
                  matPrefix
                  class="icon-size-5 hidden sm:flex"
                  [svgIcon]="'heroicons_outline:calendar'"></mat-icon>
                <input
                  matInput
                  [matDatepicker]="initDatepicker"
                  [matDatepickerFilter]="myFilter"
                  [formControlName]="'fechaDesembolso'"
                  [placeholder]="'Fecha de Desembolso'"
                  (dateChange)="changeFechaDesembolso($event)" />
                <mat-datepicker-toggle matSuffix [for]="initDatepicker"> </mat-datepicker-toggle>
                <mat-datepicker #initDatepicker></mat-datepicker>
              </mat-form-field>
              <ng-container *ngIf="fechaDesembolso.touched">
                <mat-error *ngIf="fechaDesembolso.errors?.['required']">
                  La fecha de desembolso es requerida.
                </mat-error>
                <mat-error *ngIf="fechaDesembolso.errors?.['matDatepickerFilter']">
                  La fecha de desembolso no puede ser domingo.
                </mat-error>
              </ng-container>
            </div>
            <!-- Colocador o Referido -->
            <div class="w-full">
              <mat-form-field class="w-full" subscriptSizing="dynamic"
                ><mat-label>Referido por</mat-label>
                <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:academic-cap'" matPrefix></mat-icon>
                <mat-select [formControlName]="'referidoPor'">
                  <mat-option>Elija una opción</mat-option>
                  <mat-option [value]="'COLOCADOR'">Colocador</mat-option
                  ><mat-option [value]="'CLIENTE'">Cliente</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <!-- Colocador -->
            <div class="w-full">
              <!-- Colocador Usuario -->
              <mat-form-field class="w-full" subscriptSizing="dynamic" *ngIf="referidoPor.value === 'COLOCADOR'"
                ><mat-label>Colocador</mat-label>
                <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:academic-cap'" matPrefix></mat-icon>
                <mat-select [formControlName]="'colocador'">
                  <mat-option>Elija una opción</mat-option>
                  <mat-option *ngFor="let colocador of colocadores$ | async" [value]="colocador.id"
                    >{{ colocador.nombre }} {{ colocador.apellido }}</mat-option
                  >
                </mat-select>
              </mat-form-field>
              <!-- Colocador Cliente -->
              <mat-form-field class="w-full" subscriptSizing="dynamic" *ngIf="referidoPor.value === 'CLIENTE'">
                <mat-label>Colocador</mat-label>
                <mat-icon class="icon-size-5" matPrefix [svgIcon]="'heroicons_solid:search'"></mat-icon>
                <input
                  matInput
                  [formControl]="searchInputReferral"
                  [matAutocomplete]="referral"
                  [placeholder]="'Buscar cliente'" />
                <mat-autocomplete #referral="matAutocomplete" [displayWith]="displayFn">
                  <ng-container *ngIf="clientes$ | async as clientes">
                    <ng-container *ngIf="clientes.length > 0; else noResultsTemplate">
                      <mat-option *ngFor="let cliente of clientes" [value]="cliente">
                        {{ cliente.nombre }} {{ cliente.apellidoPaterno }}
                        {{ cliente.apellidoMaterno }}
                      </mat-option>
                    </ng-container>
                    <ng-template #noResultsTemplate>
                      <mat-option class="font-bold" *ngIf="searchInputReferral.value"
                        >No existen clientes con ese criterio</mat-option
                      >
                    </ng-template></ng-container
                  >
                </mat-autocomplete>
              </mat-form-field>
            </div>
          </div>
          <div class="flex flex-auto justify-center">
            <button mat-stroked-button type="button" matStepperPrevious>Anterior</button>
            <button
              class="ml-4"
              mat-flat-button
              type="button"
              [color]="'primary'"
              matStepperNext
              [disabled]="
                !monto.touched ||
                monto.invalid ||
                fechaDesembolso.invalid ||
                !fechaDesembolso.touched ||
                colocador.invalid ||
                !colocador.touched
              ">
              Siguiente
            </button>
          </div>
        </div></mat-step
      >
      <mat-step label="Resumen de la Operación"
        ><div class="flex w-full flex-col gap-6 p-10">
          <h2 class="flex-auto self-center text-3xl font-extrabold leading-none tracking-tight">Datos Generales</h2>
          <div
            class="mt-3 grid w-full grid-cols-1 content-center gap-6 border-b border-t py-6 md:grid-cols-4"
            *ngIf="resumenOperacion as details">
            <!-- Nombre -->
            <div class="flex flex-col gap-2">
              <div class="flex gap-2">
                <mat-icon
                  role="img"
                  class="mat-icon notranslate mat-icon-no-color"
                  aria-hidden="true"
                  [svgIcon]="'heroicons_solid:user'"
                  matPrefix>
                </mat-icon>
                <div class="font-light leading-6">Nombre del Cliente:</div>
              </div>
              <div class="font-bold leading-6">
                {{ selectedCliente.nombre }}
                {{ selectedCliente.apellidoPaterno }}
                {{ selectedCliente.apellidoMaterno }}
              </div>
            </div>
            <!-- Monto -->
            <div class="flex flex-col gap-2">
              <div class="flex gap-2">
                <mat-icon
                  role="img"
                  class="mat-icon notranslate mat-icon-no-color"
                  aria-hidden="true"
                  [svgIcon]="'heroicons_outline:currency-dollar'"
                  matPrefix>
                </mat-icon>
                <div class="font-light leading-6">Monto a Otorgar:</div>
              </div>
              <div class="font-bold leading-6">
                {{ monto.value | currency : 'MXN' : 'symbol' }}
              </div>
            </div>
            <!-- Seguro -->
            <div class="flex flex-col gap-2">
              <div class="flex gap-2">
                <mat-icon
                  role="img"
                  class="mat-icon notranslate mat-icon-no-color"
                  aria-hidden="true"
                  [svgIcon]="'heroicons_outline:clipboard-check'"
                  matPrefix>
                </mat-icon>
                <div class="font-light leading-6">Modalidad de Seguro:</div>
              </div>
              <div class="font-bold leading-6">
                {{ selectedModalidadDeSeguro?.descripcion }}
              </div>
            </div>
            <!-- Producto -->
            <div class="flex flex-col gap-2">
              <div class="flex gap-2">
                <mat-icon
                  role="img"
                  class="mat-icon notranslate mat-icon-no-color"
                  aria-hidden="true"
                  [svgIcon]="'heroicons_outline:clipboard-check'"
                  matPrefix>
                </mat-icon>
                <div class="font-light leading-6">Producto a otorgar:</div>
              </div>
              <div class="font-bold leading-6">
                {{ selectedProducto.descripcion }}
              </div>
            </div>
            <!-- Capital -->
            <div class="flex flex-col gap-2">
              <div class="flex gap-2">
                <mat-icon
                  role="img"
                  class="mat-icon notranslate mat-icon-no-color"
                  aria-hidden="true"
                  [svgIcon]="'heroicons_outline:currency-dollar'"
                  matPrefix>
                </mat-icon>
                <div class="font-light leading-6">Pago a Capital:</div>
              </div>
              <div class="font-bold leading-6">
                {{ resumenOperacion.capital | currency : 'MXN' : 'symbol' }}
              </div>
            </div>
            <!-- Intereses -->
            <div class="flex flex-col gap-2">
              <div class="flex gap-2">
                <mat-icon
                  role="img"
                  class="mat-icon notranslate mat-icon-no-color"
                  aria-hidden="true"
                  [svgIcon]="'heroicons_outline:currency-dollar'"
                  matPrefix>
                </mat-icon>
                <div class="font-light leading-6">Pago a Intereses:</div>
              </div>
              <div class="font-bold leading-6">
                {{ resumenOperacion.interes | currency : 'MXN' : 'symbol' }}
              </div>
            </div>
            <!-- Seguro -->
            <div class="flex flex-col gap-2">
              <div class="flex gap-2">
                <mat-icon
                  role="img"
                  class="mat-icon notranslate mat-icon-no-color"
                  aria-hidden="true"
                  [svgIcon]="'heroicons_outline:currency-dollar'"
                  matPrefix>
                </mat-icon>
                <div class="font-light leading-6">Pago a Seguro:</div>
              </div>
              <div class="font-bold leading-6">
                {{
                  resumenOperacion.seguro > 0 ? (resumenOperacion.seguro | currency : 'MXN' : 'symbol') : 'Sin Seguro'
                }}
              </div>
            </div>
            <!-- Cuota -->
            <div class="flex flex-col gap-2">
              <div class="flex gap-2">
                <mat-icon
                  role="img"
                  class="mat-icon notranslate mat-icon-no-color"
                  aria-hidden="true"
                  [svgIcon]="'heroicons_outline:currency-dollar'"
                  matPrefix>
                </mat-icon>
                <div class="font-light leading-6">Cuota de recuperación:</div>
              </div>
              <div class="font-bold leading-6">
                {{ resumenOperacion.cuota | currency : 'MXN' : 'symbol' }}
              </div>
            </div>
            <!-- Comisión por Apertura -->
            <div class="flex flex-col gap-2">
              <div class="flex gap-2">
                <mat-icon
                  role="img"
                  class="mat-icon notranslate mat-icon-no-color"
                  aria-hidden="true"
                  [svgIcon]="'heroicons_outline:currency-dollar'"
                  matPrefix>
                </mat-icon>
                <div class="font-light leading-6">Comisión por Apertura:</div>
              </div>
              <div class="font-bold leading-6">
                {{ resumenOperacion.apertura | currency : 'MXN' : 'symbol' }}
              </div>
            </div>
            <!-- Total hoy -->
            <div class="flex flex-col gap-2">
              <div class="flex gap-2">
                <mat-icon
                  role="img"
                  class="mat-icon notranslate mat-icon-no-color"
                  aria-hidden="true"
                  [svgIcon]="'heroicons_outline:currency-dollar'"
                  matPrefix>
                </mat-icon>
                <div class="font-light leading-6">Total a pagar hoy:</div>
              </div>
              <div class="font-bold leading-6">
                {{ resumenOperacion.total | currency : 'MXN' : 'symbol' }}
              </div>
            </div>
          </div>
          <!-- Observaciones -->
          <mat-form-field class="fuse-mat-textarea mt-4 w-full" subscriptSizing="dynamic">
            <mat-label>Observaciones</mat-label>
            <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:clipboard-list'" matPrefix></mat-icon>
            <textarea [formControlName]="'observaciones'" matInput></textarea>
          </mat-form-field>
        </div>
        <div class="flex flex-auto justify-center">
          <button mat-stroked-button type="button" matStepperPrevious>Anterior</button>
          <button
            class="ml-4"
            mat-flat-button
            type="button"
            [class.spinner-loading]="desembolsando"
            [color]="'primary'"
            (click)="desembolsar()">
            {{ desembolsando ? 'Desembolsando...' : 'Desembolsar' }}
          </button>
        </div></mat-step
      >
    </mat-stepper>
  </form>
</ng-template>
<ng-template #loadingTemplate>
  <div class="flex flex-auto flex-col self-center">
    <mat-spinner> </mat-spinner>
  </div>
</ng-template>
